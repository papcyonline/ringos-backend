generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ──────────────────────────────────────────────

enum CompanionMode {
  CALM_LISTENER
  LIGHT_AND_FUN
  NIGHT_COMPANION
  MOTIVATOR
}

enum MatchIntent {
  VENT
  CASUAL_CHAT
  DEEP_TALK
  ADVICE
  JUST_LISTEN
}

enum MoodTag {
  HAPPY
  SAD
  ANXIOUS
  LONELY
  ANGRY
  NEUTRAL
  EXCITED
  TIRED
  OVERWHELMED
  HOPEFUL
}

enum ConversationType {
  HUMAN_MATCHED
  AI_HANDOFF
  GROUP
}

enum ParticipantRole {
  ADMIN
  MEMBER
}

enum CallType {
  AUDIO
  VIDEO
}

enum CallLogStatus {
  COMPLETED
  MISSED
  REJECTED
}

enum MatchRequestStatus {
  WAITING
  MATCHED
  EXPIRED
  CANCELLED
}

enum ConversationStatus {
  ACTIVE
  ENDED
}

enum AiSessionStatus {
  ACTIVE
  ENDED
}

enum AiMessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum ReportReason {
  HARASSMENT
  SPAM
  INAPPROPRIATE_CONTENT
  SELF_HARM
  THREATS
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
  DISMISSED
}

enum BanStatus {
  NONE
  WARNING
  TEMP_BAN
  PERMANENT_BAN
}

// ─── Models ─────────────────────────────────────────────

model User {
  id            String    @id @default(uuid())
  email         String?   @unique
  passwordHash  String?
  googleId      String?   @unique  // Google OAuth user ID
  appleId       String?   @unique  // Apple Sign-In user ID
  authProvider  String    @default("email") // "email", "google", "apple", "phone", "anonymous"
  deviceId      String?   @unique
  phoneHash     String?   @unique
  phoneLookup   String?   @unique  // SHA-256 of phone for fast lookups
  displayName   String    // Auto-generated like "Gentle Owl 17"
  avatarUrl     String?
  bio           String?
  profession    String?
  gender        String?   // "male", "female", "other"
  location      String?
  status        String    @default("available") // "available", "busy"
  availabilityNote String? // e.g. "Available for 15min call", "Free in 30 mins"
  isAnonymous   Boolean   @default(true)
  isOnline      Boolean   @default(false)
  lastSeenAt    DateTime?
  availableFor  String[]  @default(["text"])
  availableUntil DateTime?
  isVerified    Boolean   @default(false)
  verifiedAt    DateTime?
  verifiedRole  String?
  isProfilePublic Boolean @default(true)
  banStatus     BanStatus @default(NONE)
  banExpiresAt  DateTime?
  flagCount     Int       @default(0)
  lastFlaggedAt DateTime?
  // Stripe subscription
  stripeCustomerId    String?   @unique
  subscriptionId      String?
  subscriptionStatus  String?   // "active", "cancelled", "past_due", "trialing"
  subscriptionPlan    String?   // "premium", "pro", etc.
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  preference     UserPreference?
  refreshTokens  RefreshToken[]
  aiSessions     AiSession[]
  matchRequests  MatchRequest[]
  conversations  ConversationParticipant[]
  messages       Message[]
  reportsMade    Report[]  @relation("ReportsMade")
  reportsAgainst Report[]  @relation("ReportsAgainst")
  blocksInitiated  Block[]  @relation("BlocksInitiated")
  blocksReceived   Block[]  @relation("BlocksReceived")
  followsInitiated Follow[] @relation("FollowsInitiated")
  followsReceived  Follow[] @relation("FollowsReceived")
  likesInitiated   Like[]   @relation("LikesInitiated")
  likesReceived    Like[]   @relation("LikesReceived")
  reactions        MessageReaction[]
  callLogs         CallLog[]
  notifications    Notification[]
  fcmTokens        FcmToken[]
  voipTokens       VoipToken[]

  @@index([banStatus])
}

model UserPreference {
  id        String      @id @default(uuid())
  userId    String      @unique
  mood      MoodTag     @default(NEUTRAL)
  language  String      @default("en")
  timezone  String      @default("UTC")
  topics    String[]    @default([])
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model OtpCode {
  id        String   @id @default(uuid())
  key       String   // phone number or "reset:<email>"
  code      String
  attempts  Int      @default(0)
  maxAttempts Int    @default(5)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@unique([key])
  @@index([expiresAt])
}

model AiSession {
  id       String          @id @default(uuid())
  userId   String
  mode     CompanionMode
  status   AiSessionStatus @default(ACTIVE)
  metadata Json?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  user     User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages AiMessage[]

  @@index([userId, status])
}

model AiMessage {
  id        String        @id @default(uuid())
  sessionId String
  role      AiMessageRole
  content   String
  mood      MoodTag?
  metadata  Json?
  createdAt DateTime      @default(now())

  session AiSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

model MatchRequest {
  id        String             @id @default(uuid())
  userId    String
  intent    MatchIntent
  mood      MoodTag            @default(NEUTRAL)
  language  String             @default("en")
  timezone  String             @default("UTC")
  topics    String[]           @default([])
  status    MatchRequestStatus @default(WAITING)
  matchedWith String?
  fromAiSession String?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status, intent])
  @@index([userId])
}

model Conversation {
  id        String             @id @default(uuid())
  type      ConversationType   @default(HUMAN_MATCHED)
  status    ConversationStatus @default(ACTIVE)
  name        String?
  description String?
  avatarUrl   String?
  isVerified  Boolean            @default(false)
  metadata  Json?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  participants ConversationParticipant[]
  messages     Message[]
  callLogs     CallLog[]
}

model ConversationParticipant {
  id             String          @id @default(uuid())
  conversationId String
  userId         String
  role           ParticipantRole @default(MEMBER)
  lastReadAt     DateTime?
  joinedAt       DateTime        @default(now())
  leftAt         DateTime?

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
}

model Message {
  id             String    @id @default(uuid())
  conversationId String
  senderId       String
  content        String
  isSystem       Boolean   @default(false)
  metadata       Json?
  replyToId      String?
  imageUrl       String?
  audioUrl       String?
  audioDuration  Int?
  viewOnce       Boolean   @default(false)
  viewOnceOpened Boolean   @default(false)
  editedAt       DateTime?
  deletedAt      DateTime?
  createdAt      DateTime  @default(now())

  conversation Conversation       @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User               @relation(fields: [senderId], references: [id], onDelete: Cascade)
  replyTo      Message?           @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies      Message[]          @relation("MessageReplies")
  reactions    MessageReaction[]

  @@index([conversationId, createdAt])
}

model MessageReaction {
  id        String   @id @default(uuid())
  messageId String
  userId    String
  emoji     String
  createdAt DateTime @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
}

model Report {
  id         String       @id @default(uuid())
  reporterId String
  reportedId String
  reason     ReportReason
  details    String?
  status     ReportStatus @default(PENDING)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  reporter User @relation("ReportsMade", fields: [reporterId], references: [id], onDelete: Cascade)
  reported User @relation("ReportsAgainst", fields: [reportedId], references: [id], onDelete: Cascade)

  @@index([reportedId, status])
}

model Block {
  id        String   @id @default(uuid())
  blockerId String
  blockedId String
  createdAt DateTime @default(now())

  blocker User @relation("BlocksInitiated", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked User @relation("BlocksReceived", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
}

model Follow {
  id          String   @id @default(uuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower  User @relation("FollowsInitiated", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("FollowsReceived", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Like {
  id        String   @id @default(uuid())
  likerId   String
  likedId   String
  createdAt DateTime @default(now())

  liker User @relation("LikesInitiated", fields: [likerId], references: [id], onDelete: Cascade)
  liked User @relation("LikesReceived", fields: [likedId], references: [id], onDelete: Cascade)

  @@unique([likerId, likedId])
  @@index([likerId])
  @@index([likedId])
}

model CallLog {
  id             String        @id @default(uuid())
  callId         String        @unique
  conversationId String
  initiatorId    String
  callType       CallType      @default(AUDIO)
  status         CallLogStatus @default(MISSED)
  startedAt      DateTime      @default(now())
  endedAt        DateTime?
  durationSecs   Int?

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  initiator    User         @relation(fields: [initiatorId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([initiatorId])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String   // "chat_message", "new_follower", "profile_liked", "match_found"
  title     String
  body      String
  imageUrl  String?
  data      Json     @default("{}")
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
}

model FcmToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VoipToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  platform  String   // 'ios'
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
